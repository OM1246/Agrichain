<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Successful ‚Äî AgriChain</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- html2pdf for receipt generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        .success-box {
            text-align: center;
            max-width: 500px;
            margin: 4rem auto;
            padding: 3rem 2rem;
            animation: bounceIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: scale(0.9);
        }
        @keyframes bounceIn {
            to { opacity: 1; transform: scale(1); }
        }
        .check-circle {
            width: 80px;
            height: 80px;
            background: rgba(0,229,160,0.15);
            border: 2px solid var(--emerald);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem auto;
            font-size: 2.5rem;
            color: var(--emerald);
            box-shadow: 0 0 30px rgba(0,229,160,0.2);
        }
        .receipt-container {
            text-align: left;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .receipt-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
        }
        .receipt-row:last-child { border-bottom: none; padding-bottom: 0; }
        .receipt-label { color: var(--gray); font-weight: 500; }
        .receipt-value { color: #fff; font-weight: 600; max-width: 60%; word-break: break-all; text-align: right; }
        
        /* Hidden printable element specifically formulated for nice PDFs without dark mode backgrounds */
        #printArea { display: none; }
    </style>
</head>
<body>
    <nav class="glass-nav">
        <div class="logo">Agri<span>Chain</span></div>
        <div class="nav-links">
            <a href="farmer.html" class="active">‚Üê Return to Dashboard</a>
        </div>
    </nav>

    <main class="container">
        <div class="glass-card success-box" id="successBox">
            <div class="check-circle">‚úì</div>
            <h1 style="color:#fff; margin-bottom:0.5rem; font-size:2rem;">Payment Successful!</h1>
            <p style="color:var(--gray); margin-bottom:2rem;">Your transaction has been securely processed and recorded.</p>
            
            <div class="receipt-container" id="displayReceipt">
                <!-- Injected via JS -->
            </div>

            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn-primary" onclick="downloadReceipt()" style="flex:1;">üìÑ Download Receipt</button>
                <a href="farmer.html" class="btn-outline" style="flex:1; text-align:center; display:inline-flex; justify-content:center; align-items:center;">Back to Market</a>
            </div>
        </div>
    </main>

    <!-- Invisible template exclusively structured and styled for html2pdf generation -->
    <div id="printArea">
        <div style="padding: 40px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #333; background: #fff; width: 600px;">
            <div style="text-align:center; padding-bottom:20px; border-bottom: 2px solid #eee; margin-bottom:30px;">
                <h1 style="margin:0; color:#00e5a0; font-size:28px;">AgriChain Receipt</h1>
                <p style="margin:5px 0 0 0; color:#777;">Official Transaction Record</p>
            </div>
            
            <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                <tr>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666; width:40%;">Order ID</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right;" id="pdfOrder"></td>
                </tr>
                <tr>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666;">Date</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right;" id="pdfDate"></td>
                </tr>
                <tr>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666;">Product</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right;" id="pdfProduct"></td>
                </tr>
                <tr>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666;">Action</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right;" id="pdfAction"></td>
                </tr>
                <tr id="pdfDurationRow">
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666;" id="pdfDurationLabel">Duration</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right;" id="pdfDurationValue"></td>
                </tr>
                <tr>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; color:#666;">Metamask Tx Hash</td>
                    <td style="padding:12px 0; border-bottom:1px solid #f5f5f5; font-weight:bold; text-align:right; font-size:12px; word-break:break-all;" id="pdfHash"></td>
                </tr>
            </table>

            <div style="background:#f9f9f9; padding:20px; border-radius:8px; text-align:right;">
                <span style="color:#666; font-size:14px; margin-right:15px;">Total Amount Paid</span>
                <span style="font-size:24px; font-weight:bold; color:#333;" id="pdfTotal"></span>
            </div>

            <div style="text-align:center; margin-top:50px; font-size:12px; color:#aaa;">
                <p>Thank you for using AgriChain.</p>
                <p>To verify this transaction, you may search the Tx Hash on the blockchain explorer.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataStr = sessionStorage.getItem('txSuccessData');
            if (!dataStr) {
                document.getElementById('successBox').innerHTML = '<h2 style="color:#fff;">No recent transaction found!</h2><br><a href="farmer.html" class="btn-primary">Return to Dashboard</a>';
                return;
            }

            const data = JSON.parse(dataStr);

            // Populate on-screen receipt
            const disp = document.getElementById('displayReceipt');
            const durationLabel = data.action === 'buy' ? 'Quantity' : 'Rental Duration';
            const durationVal = data.action === 'buy' ? data.quantity + ' items' : data.rentDays + ' days';
            const showHash = data.txHash && data.txHash !== 'N/A';

            disp.innerHTML = `
                <div class="receipt-row"><span class="receipt-label">Order ID</span><span class="receipt-value">${data.orderId}</span></div>
                <div class="receipt-row"><span class="receipt-label">Date</span><span class="receipt-value">${data.date}</span></div>
                <div class="receipt-row"><span class="receipt-label">Product</span><span class="receipt-value">${data.productName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Seller Name</span><span class="receipt-value">${data.farmerName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Type</span><span class="receipt-value" style="text-transform:capitalize;">${data.action}</span></div>
                <div class="receipt-row"><span class="receipt-label">${durationLabel}</span><span class="receipt-value">${durationVal}</span></div>
                ${showHash ? `<div class="receipt-row"><span class="receipt-label">Tx Hash</span><span class="receipt-value" style="font-size:0.75rem; color:var(--emerald);">${data.txHash}</span></div>` : ''}
                <div class="receipt-row" style="margin-top:10px; font-size:1.1rem;"><span class="receipt-label">Amount Paid</span><span class="receipt-value">‚Çπ${data.price.toFixed(2)}</span></div>
            `;

            // Populate PDF template
            document.getElementById('pdfOrder').textContent = data.orderId;
            document.getElementById('pdfDate').textContent = data.date;
            document.getElementById('pdfProduct').textContent = data.productName;
            document.getElementById('pdfAction').textContent = data.action.toUpperCase();
            document.getElementById('pdfDurationLabel').textContent = durationLabel;
            document.getElementById('pdfDurationValue').textContent = durationVal;
            document.getElementById('pdfTotal').textContent = '‚Çπ' + data.price.toFixed(2);
            document.getElementById('pdfHash').textContent = showHash ? data.txHash : 'Fiat Payment (N/A)';
            
            // Clean up session so refreshing doesn't keep showing it forever, optional.
            // sessionStorage.removeItem('txSuccessData');
        });

        function downloadReceipt() {
            const elm = document.getElementById('printArea');
            elm.style.display = 'block'; // Unhide for capture
            
            const opt = {
                margin:       0,
                filename:     'AgriChain_Receipt.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(elm).save().then(() => {
                elm.style.display = 'none'; // Re-hide after capture
            });
        }
    </script>
</body>
</html>
